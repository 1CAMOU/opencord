<script>
	import { onMount } from 'svelte';
	import { fade } from 'svelte/transition';
	import { generatePrivateKey, getPublicKey } from 'nostr-tools';

	let error = '';
	let privkey = null;
	let hasExtension = false;

	onMount(() => {
		setTimeout(() => {
			hasExtension = !!window.nostr;
		}, 1000);
	});

	const generatePrivKey = () => {
		privkey = generatePrivateKey();
	};

	const logInWithExtension = async () => {
		const pubkey = await window.nostr.getPublicKey();

		if (!pubkey.match(/[a-z0-9{64}]/)) {
			error = 'The entered public key is invalid. Please try again.';
		} else {
			privkey = '';
		}
	};
</script>

<div class="w-full max-w-3xl mx-auto mt-20 text-center">
	<h1 class="text-4xl font-bold mb-4 tracking-tight uppercase">Welcome to</h1>
	<div class="h-16 mt-14">
		<svg
			class="h-full w-full"
			id="Layer_2"
			xmlns="http://www.w3.org/2000/svg"
			viewBox="0 0 1799.28 300.86"
			><defs
				><style>
					.cls-1 {
						fill: #19e19b;
					}
				</style></defs
			><g id="Layer_1-2"
				><g
					><g
						><path
							d="m492.53,205.46c-23.17,22.95-51.36,34.42-84.59,34.42s-61.42-11.48-84.58-34.42c-22.95-23.38-34.42-51.69-34.42-84.91s11.48-61.63,34.42-84.58C346.52,12.8,374.72,1.22,407.94,1.22s61.41,11.59,84.59,34.75c23.16,22.95,34.75,51.14,34.75,84.58s-11.59,61.75-34.75,84.91m-137.36-30.82c13.98,13.99,31.58,20.98,52.78,20.98s38.79-6.99,52.78-20.98c14.21-14.21,21.31-32.24,21.31-54.1s-7.11-39.88-21.31-54.09c-14.21-14.2-31.8-21.31-52.78-21.31s-38.58,7.11-52.78,21.31-21.31,32.24-21.31,54.09,7.1,39.89,21.31,54.1"
						/><path
							d="m645.95,66.79c22.07,0,40.87,8.42,56.39,25.24,15.73,16.83,23.6,37.27,23.6,61.31s-7.87,45.02-23.6,61.63c-15.3,16.61-34.09,24.92-56.39,24.92s-40.66-7.98-53.11-23.93v84.91h-42.29V71.37h42.29v19.35c12.46-15.95,30.16-23.93,53.11-23.93m-40.33,119.99c8.52,8.53,19.35,12.78,32.46,12.78s23.93-4.26,32.46-12.78c8.74-8.74,13.11-19.88,13.11-33.44s-4.38-24.59-13.11-33.11c-8.53-8.74-19.34-13.11-32.46-13.11s-23.93,4.37-32.46,13.11c-8.53,8.53-12.78,19.56-12.78,33.11s4.26,24.7,12.78,33.44"
						/><path
							d="m908.55,170.71h-123.6c5.46,20.55,20.87,30.82,46.23,30.82,16.17,0,28.41-5.46,36.72-16.39l34.1,19.67c-16.18,23.39-39.99,35.08-71.47,35.08-27.1,0-48.85-8.2-65.24-24.59-16.4-16.39-24.59-37.04-24.59-61.96s8.08-45.02,24.26-61.63c15.95-16.61,36.72-24.92,62.29-24.92s44.03,8.31,59.34,24.92c15.73,16.61,23.6,37.16,23.6,61.63,0,4.59-.55,10.38-1.64,17.38m-124.25-32.78h83.6c-2.41-10.7-7.27-18.9-14.59-24.59-7.33-5.68-16.01-8.52-26.06-8.52-11.37,0-20.77,2.9-28.2,8.69-7.43,5.79-12.35,13.93-14.75,24.42"
						/><path
							d="m1024.27,66.78c18.14,0,32.89,6.01,44.26,18.03,11.81,12.24,17.7,28.85,17.7,49.83v100.65h-42.29v-95.4c0-10.71-2.9-19.02-8.68-24.92-5.8-5.9-13.72-8.85-23.77-8.85-11.15,0-19.95,3.44-26.39,10.33-6.45,6.88-9.67,17-9.67,30.33v88.52h-42.29V71.38h42.29v18.36c10.05-15.3,26.33-22.95,48.85-22.95"
						/><path
							d="m1228.84,239.55c-34.97,0-63.71-11.47-86.22-34.42-22.51-22.73-33.77-50.92-33.77-84.58s11.26-61.85,33.77-84.58c22.51-22.95,51.25-34.42,86.22-34.42,20.76,0,39.99,5.03,57.7,15.08,17.7,10.06,31.47,23.6,41.31,40.65l-26.56,15.41c-6.56-12.68-16.34-22.79-29.34-30.32-13-7.54-27.37-11.31-43.11-11.31-26.67,0-48.31,8.53-64.91,25.57-16.61,16.83-24.92,38.14-24.92,63.93s8.31,46.77,24.92,63.6c16.61,17.05,38.24,25.57,64.91,25.57,15.74,0,30.11-3.77,43.11-11.31,13-7.54,22.78-17.54,29.34-30l26.56,15.08c-9.63,17.05-23.28,30.71-40.98,40.98-17.49,10.05-36.83,15.08-58.03,15.08"
						/><path
							d="m1490.46,214.64c-16.61,16.61-37.05,24.91-61.31,24.91s-44.7-8.3-61.3-24.91c-16.61-16.61-24.92-37.05-24.92-61.31s8.31-44.69,24.92-61.31c16.61-16.61,37.04-24.92,61.3-24.92s44.7,8.31,61.31,24.92c16.83,16.83,25.25,37.27,25.25,61.31s-8.42,44.48-25.25,61.31m-61.31-2.95c16.4,0,30.17-5.57,41.31-16.72,11.15-11.15,16.72-25.02,16.72-41.64s-5.57-30.49-16.72-41.64c-11.14-11.15-24.91-16.72-41.31-16.72s-29.83,5.57-40.98,16.72c-11.15,11.15-16.72,25.03-16.72,41.64s5.57,30.49,16.72,41.64c11.15,11.14,24.8,16.72,40.98,16.72"
						/><path
							d="m1571.43,71.37v27.54c9.39-20.33,26.45-30.49,51.14-30.49v29.83c-13.99-.66-26.01,3.06-36.06,11.15-10.06,8.09-15.08,21.1-15.08,39.01v86.88h-28.52V71.37h28.52Z"
						/><path
							d="m1770.76,99.57V5.81h28.52v229.49h-28.52v-28.19c-13.99,21.63-34.64,32.45-61.97,32.45-23.17,0-42.73-8.3-58.68-24.91-16.18-16.83-24.26-37.26-24.26-61.31s8.08-44.15,24.26-60.98c16.18-16.83,35.73-25.24,58.68-25.24,27.32,0,47.98,10.82,61.97,32.46m-58.36,112.45c16.61,0,30.49-5.57,41.64-16.72,11.14-11.58,16.72-25.57,16.72-41.96s-5.58-30.49-16.72-41.64c-11.15-11.36-25.03-17.05-41.64-17.05s-30.17,5.68-41.31,17.05c-11.15,11.15-16.72,25.03-16.72,41.64s5.57,30.38,16.72,41.96c11.14,11.14,24.92,16.72,41.31,16.72"
						/></g
					><g
						><path
							class="cls-1"
							d="m233.25,176.62c-6.32,6.32-16.03,8.67-24.89,5.19-11.92-4.68-17.78-18.14-13.09-30.05,11.24-28.59,4.47-61.09-17.25-82.8-30.07-30.07-79-30.07-109.07,0-30.07,30.07-30.07,79,0,109.07,21.72,21.72,54.22,28.49,82.81,17.25,11.91-4.69,25.37,1.18,30.05,13.09,4.69,11.91-1.18,25.37-13.09,30.06-45.76,17.99-97.79,7.15-132.55-27.61-11.78-11.78-20.91-25.53-27.12-40.86C3.04,155.14,0,139.51,0,123.48c0-16.03,3.04-31.66,9.05-46.46,6.22-15.33,15.34-29.08,27.12-40.86,11.78-11.78,25.53-20.91,40.86-27.12C91.83,3.04,107.46,0,123.48,0s31.66,3.04,46.46,9.04c15.34,6.22,29.08,15.34,40.86,27.12,34.76,34.76,45.6,86.79,27.61,132.55-1.21,3.06-2.99,5.72-5.17,7.91"
						/><path
							class="cls-1"
							d="m99.17,122.76c0-8.22-6.66-14.88-14.88-14.88s-14.88,6.66-14.88,14.88,6.66,14.88,14.88,14.88,14.88-6.66,14.88-14.88"
						/><path
							class="cls-1"
							d="m176.11,122.76c0-8.22-6.66-14.88-14.88-14.88s-14.88,6.66-14.88,14.88,6.66,14.88,14.88,14.88,14.88-6.66,14.88-14.88"
						/><path
							class="cls-1"
							d="m137.64,122.76c0-8.22-6.66-14.88-14.88-14.88s-14.88,6.66-14.88,14.88,6.66,14.88,14.88,14.88,14.88-6.66,14.88-14.88"
						/></g
					></g
				></g
			></svg
		>
	</div>

	<div class="mt-20 p-12 w-full h-full bg-white border shadow-lg rounded-xl text-left">
		<h2 class="text-2xl font-bold mb-6 tracking-tight text-center">Log in</h2>

		<p class="text-neutral-700 mb-6">
			Please enter the private key for your Nostr Account below or use a <a
				href="https://github.com/nostr-protocol/nips/blob/master/07.md"
				target="_blank"
				rel="noopener noreferrer"
				class="text-emerald-500 hover:text-opencord transition">compatible browser extension</a
			> to log in.
		</p>

		<div class="flex flex-col mt-1">
			<label for="privkey" class="sr-only">Private Key</label>
			<div class="relative">
				<input
					bind:value={privkey}
					name="privkey"
					id="privkey"
					type="text"
					placeholder="Enter your Private Key..."
					class="border pl-12 pr-4 w-full py-1.5 text-sm focus:outline-none focus:ring focus:ring-opencord focus:ring-opacity-50 rounded-md"
				/>

				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 20 20"
					fill="currentColor"
					class="w-4 h-4 absolute top-1/2 -translate-y-1/2 left-4"
				>
					<path
						fill-rule="evenodd"
						d="M8 7a5 5 0 113.61 4.804l-1.903 1.903A1 1 0 019 14H8v1a1 1 0 01-1 1H6v1a1 1 0 01-1 1H3a1 1 0 01-1-1v-2a1 1 0 01.293-.707L8.196 8.39A5.002 5.002 0 018 7zm5-3a.75.75 0 000 1.5A1.5 1.5 0 0114.5 7 .75.75 0 0016 7a3 3 0 00-3-3z"
						clip-rule="evenodd"
					/>
				</svg>
			</div>
		</div>

		<div class="flex justify-center mt-4 space-x-4">
			{#if hasExtension}
				<button
					on:click={logInWithExtension}
					in:fade
					class="text-sm w-full border flex justify-center items-center px-4 py-1.5 hover:bg-opencord transition focus:outline-none focus:ring focus:ring-opencord focus:ring-opacity-50 rounded-md"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 24 24"
						stroke-width="1.5"
						stroke="currentColor"
						class="w-4 h-4 mr-3"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 01-.657.643 48.39 48.39 0 01-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 01-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 00-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 01-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 00.657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 01-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 005.427-.63 48.05 48.05 0 00.582-4.717.532.532 0 00-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 00.658-.663 48.422 48.422 0 00-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 01-.61-.58v0z"
						/>
					</svg>

					Use Extension
				</button>
			{/if}

			<button
				on:click={generatePrivKey}
				class="text-sm w-full border flex justify-center items-center px-4 py-1.5 hover:bg-opencord transition focus:outline-none focus:ring focus:ring-opencord focus:ring-opacity-50 rounded-md"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					fill="none"
					viewBox="0 0 24 24"
					stroke-width="1.5"
					stroke="currentColor"
					class="w-4 h-4 mr-3"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
					/>
				</svg>

				Generate Key
			</button>
		</div>

		{#if error}
			<p in:fade class="text-sm text-red-500 mt-8 text-center w-full">Error! {error}</p>
		{/if}

		<button
			class="{privkey ??
				'opacity-40 pointer-events-none select-none'} text-sm w-full bg-opencord mt-8 border flex justify-center items-center px-4 py-1.5 hover:bg-emerald-400 transition focus:outline-none focus:ring focus:ring-opencord focus:ring-opacity-50 rounded-md"
		>
			Continue
		</button>
	</div>
</div>
